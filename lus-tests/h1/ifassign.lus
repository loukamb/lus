--[[
  Tests for if/elseif assignment conditions in Lus
  
  The feature allows:
    if var = expr then ... end
    if a, b = expr1, expr2 then ... end
  
  Variables declared in conditions are visible in all subsequent blocks.
  If any assigned value is nil/false, the condition is false.
]]

global print, setmetatable, assert, _G, require, os, pledge

pledge("load", "fs:read=./lus-tests/*", "seal")

local framework = require("lus-tests.framework")
local tests = framework.new("ifassign")

tests:it("if with truthy assignment", function()
    local result = nil
    if x = 42 then
        result = x
    end
    assert(result == 42, "x should be 42")
end)

tests:it("if with falsy assignment (nil)", function()
    local result = "not entered"
    if x = nil then
        result = "entered"
    end
    assert(result == "not entered", "should not enter block when nil")
end)

tests:it("if with falsy assignment (false)", function()
    local result = "not entered"
    if x = false then
        result = "entered"
    end
    assert(result == "not entered", "should not enter block when false")
end)

tests:it("if with string value", function()
    local result = nil
    if s = "hello" then
        result = s
    end
    assert(result == "hello", "s should be 'hello'")
end)

tests:it("if with zero (truthy in Lua)", function()
    local result = nil
    if x = 0 then
        result = x
    end
    assert(result == 0, "0 is truthy, x should be 0")
end)

tests:it("if with empty string (truthy in Lua)", function()
    local result = nil
    if s = "" then
        result = s
    end
    assert(result == "", "empty string is truthy")
end)

tests:it("if with function call returning truthy value", function()
    local function getValue()
        return 100
    end
    local result = nil
    if v = getValue() then
        result = v
    end
    assert(result == 100, "v should be 100")
end)

tests:it("if with function call returning nil", function()
    local function getNil()
        return nil
    end
    local result = "not entered"
    if v = getNil() then
        result = "entered"
    end
    assert(result == "not entered", "should not enter block")
end)

tests:it("keepIfSumOverTen example from docs", function()
    local function keepIfSumOverTen(a, b)
        local c = a + b
        return c > 10 and c or nil
    end
    
    local result1 = nil
    if s = keepIfSumOverTen(9, 2) then
        result1 = s
    end
    assert(result1 == 11, "9 + 2 = 11 which is over 10")
    
    local result2 = "not entered"
    if s = keepIfSumOverTen(3, 4) then
        result2 = s
    end
    assert(result2 == "not entered", "3 + 4 = 7 which is not over 10")
end)

tests:it("multiple variables all truthy", function()
    local result = nil
    if a, b, c = 1, 5, 9 then
        result = a + b + c
    end
    assert(result == 15, "a+b+c should be 15")
end)

tests:it("multiple variables with one nil (first)", function()
    local result = "not entered"
    if a, b, c = nil, 2, 3 then
        result = "entered"
    end
    assert(result == "not entered", "first value nil, should not enter")
end)

tests:it("multiple variables with one nil (middle)", function()
    local result = "not entered"
    if a, b, c = 1, nil, 3 then
        result = "entered"
    end
    assert(result == "not entered", "middle value nil, should not enter")
end)

tests:it("multiple variables with one nil (last)", function()
    local result = "not entered"
    if a, b, c = 1, 2, nil then
        result = "entered"
    end
    assert(result == "not entered", "last value nil, should not enter")
end)

tests:it("multiple variables with one false", function()
    local result = "not entered"
    if a, b, c = 3, 6, false then
        result = "entered"
    end
    assert(result == "not entered", "one value false, should not enter")
end)

tests:it("multiple variables all same value", function()
    local v = 7
    local result = nil
    if a, b, c = v, v, v then
        result = a + b + c
    end
    assert(result == 21, "all should be 7, sum is 21")
end)

tests:it("elseif with assignment when if fails", function()
    local result = nil
    if x = nil then
        result = "if"
    elseif y = 99 then
        result = y
    end
    assert(result == 99, "elseif should execute with y=99")
end)

tests:it("elseif chain", function()
    local result = nil
    if a = nil then
        result = "first"
    elseif b = false then
        result = "second"
    elseif c = "winner" then
        result = c
    end
    assert(result == "winner", "third elseif should win")
end)

tests:it("variables from if visible in elseif (from docs example)", function()
    local a_val, b_val, c_val, d_val = nil, nil, nil, nil
    if a, b, c = 3, 6, nil then
        a_val = "unexpected"
    elseif d = 9 then
        a_val = a
        b_val = b
        c_val = c
        d_val = d
    end
    assert(a_val == 3, "a should be 3 from previous condition")
    assert(b_val == 6, "b should be 6 from previous condition")
    assert(c_val == nil, "c should be nil from previous condition")
    assert(d_val == 9, "d should be 9 from elseif")
end)

tests:it("variables from if visible in else", function()
    local captured_a = nil
    if a = nil then
        -- Should not enter
    else
        captured_a = a
    end
    assert(captured_a == nil, "a should be nil in else block")
end)

tests:it("variables accumulate across conditions", function()
    local sum = 0
    if a = nil then
        -- fail
    elseif b = nil then
        -- fail
    elseif c = 10 then
        sum = (a or 0) + (b or 0) + c
    end
    assert(sum == 10, "sum should be 10 (a and b are nil)")
end)

tests:it("nested if statements with assignments", function()
    local outer_result, inner_result = nil, nil
    if outer = 5 then
        outer_result = outer
        if inner = 10 then
            inner_result = inner
        end
    end
    assert(outer_result == 5, "outer should be 5")
    assert(inner_result == 10, "inner should be 10")
end)

tests:it("inner assignment variables don't leak out", function()
    local result = "not set"
    if outer = 1 then
        if inner = 2 then
            result = inner
        end
    end
    assert(result == 2, "inner was 2")
end)

tests:it("if-assignment with else", function()
    local result = nil
    if x = nil then
        result = "if"
    else
        result = "else"
    end
    assert(result == "else", "should enter else when nil")
end)

tests:it("if-assignment elseif-assignment else chain", function()
    local result = nil
    if a = false then
        result = "if"
    elseif b = nil then
        result = "elseif"
    else
        result = "else"
    end
    assert(result == "else", "should enter else")
end)

tests:it("variables from failed conditions visible in else", function()
    local all_nil = true
    if a = nil then
        all_nil = false
    elseif b = nil then
        all_nil = false
    else
        all_nil = (a == nil) and (b == nil)
    end
    assert(all_nil, "both a and b should be nil in else")
end)

tests:it("single variable with table value", function()
    local result = nil
    if t = {1, 2, 3} then
        result = t[2]
    end
    assert(result == 2, "t[2] should be 2")
end)

tests:it("assignment from method call", function()
    local obj = {
        value = 42,
        get = function(self) return self.value end
    }
    local result = nil
    if v = obj:get() then
        result = v
    end
    assert(result == 42, "method should return 42")
end)

tests:it("assignment with arithmetic expression", function()
    local result = nil
    if x = 10 + 20 then
        result = x
    end
    assert(result == 30, "x should be 30")
end)

tests:it("multiple values from function with multiple returns", function()
    local function multi()
        return 1, 2, 3
    end
    local result = nil
    if a, b, c = multi() then
        result = a + b + c
    end
    assert(result == 6, "sum should be 6")
end)

tests:it("more variables than values (extras become nil)", function()
    local function one()
        return 100
    end
    local result = "not entered"
    if a, b = one() then
        result = "entered"
    end
    assert(result == "not entered", "b is nil, should not enter")
end)

tests:it("catch expression in if assignment", function()
    local result = nil
    local status = nil
    if ok, val = catch (1 + 2) then
        status = ok
        result = val
    end
    assert(status == true, "catch should succeed")
    assert(result == 3, "val should be 3")
end)

tests:it("condition variable not visible outside if", function()
    if cond_var = 123 then
        assert(cond_var == 123)
    end
    assert(_G.cond_var == nil, "cond_var should not leak to globals")
end)

tests:it("condition variables are local, not global", function()
    if test_global_var = 999 then
        assert(test_global_var == 999)
    end
    assert(_G.test_global_var == nil, "should not create global variable")
end)

tests:finish()