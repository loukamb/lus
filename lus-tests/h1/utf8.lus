global print, require, assert, type, string, table, utf8, math, error, ipairs, pairs, tostring

local framework = require("lus-tests.framework")
local tests = framework.new("utf8")

tests:it("utf8 char single", function()
    assert(utf8.char(65) == "A")
    assert(utf8.char(0x20AC) == "â‚¬")
    assert(utf8.char(0x1F600) == "ðŸ˜€")
end)

tests:it("utf8 char multiple", function()
    assert(utf8.char(65, 66, 67) == "ABC")
    assert(utf8.char(0x20AC, 0x20AC) == "â‚¬â‚¬")
end)

tests:it("utf8 codepoint", function()
    assert(utf8.codepoint("A") == 65)
    assert(utf8.codepoint("â‚¬") == 0x20AC)
    
    -- multiple codepoints
    local a, b, c = utf8.codepoint("ABC", 1, 3)
    assert(a == 65 and b == 66 and c == 67)
end)

tests:it("utf8 len", function()
    assert(utf8.len("A") == 1)
    assert(utf8.len("â‚¬") == 1)
    assert(utf8.len("abc") == 3)
    assert(utf8.len("Â£") == 1)
    assert(utf8.len("") == 0)
    assert(utf8.len("hello") == 5)
    assert(utf8.len("hÃ©llo") == 5)
end)

tests:it("utf8 offset", function()
    local s = "Aâ‚¬B"
    assert(utf8.offset(s, 1) == 1)
    assert(utf8.offset(s, 2) == 2)
    assert(utf8.offset(s, 3) == 5)
    assert(utf8.offset(s, 4) == 6)
end)

tests:it("utf8 offset negative", function()
    local s = "ABC"
    assert(utf8.offset(s, -1) == 3)
    assert(utf8.offset(s, -2) == 2)
    assert(utf8.offset(s, -3) == 1)
end)

tests:it("utf8 codes iterator", function()
    local s = "Aâ‚¬"
    local t = {}
    for p, c in utf8.codes(s) do
        table.insert(t, {p=p, c=c})
    end
    assert(#t == 2)
    assert(t[1].p == 1 and t[1].c == 65)
    assert(t[2].p == 2 and t[2].c == 0x20AC)
end)

tests:it("invalid sequences", function()
    assert(utf8.len("\xFF") == nil)
    local ok = catch utf8.codepoint("\xFF")
    assert(not ok)
end)

tests:it("utf8.charpattern", function()
    assert(utf8.charpattern)
    local s = "hello"
    local count = 0
    for _ in string.gmatch(s, utf8.charpattern) do
        count = count + 1
    end
    assert(count == 5)
end)

tests:finish()

