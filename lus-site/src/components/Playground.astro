---
/**
 * Interactive Lus Playground
 * Loads WASM from GitHub releases and provides a REPL interface
 */
---

<div class="playground" id="playground">
  <div class="playground-header">
    <h2>Try Lus</h2>
    <div class="version-controls">
      <select id="version-select" disabled>
        <option value="">Loading...</option>
      </select>
      <span id="version-tag"></span>
    </div>
  </div>
  <div class="playground-body">
    <div class="output" id="output">
      <div class="output-line system">Loading Lus...</div>
    </div>
    <div class="input-line">
      <span class="prompt">&gt;</span>
      <input
        type="text"
        id="input"
        placeholder="Enter Lus code..."
        disabled
        autocomplete="off"
        spellcheck="false"
      />
    </div>
  </div>
</div>

<script>
  import { getWasmReleases, loadLusWasm } from "../lib/wasm-loader"
  import type { WasmRelease, LusModule } from "../lib/wasm-loader"

  const output = document.getElementById("output")!
  const input = document.getElementById("input") as HTMLInputElement
  const versionSelect = document.getElementById(
    "version-select"
  ) as HTMLSelectElement
  const versionTag = document.getElementById("version-tag")!

  let currentModule: LusModule | null = null
  let releases: { stable: WasmRelease | null; unstable: WasmRelease | null }
  let history: string[] = []
  let historyIndex = -1

  function appendOutput(text: string, type: "input" | "output" | "error" | "system" = "output") {
    const line = document.createElement("div")
    line.className = `output-line ${type}`
    if (type === "input") {
      line.innerHTML = `<span class="prompt">&gt;</span> ${escapeHtml(text)}`
    } else {
      line.textContent = text
    }
    output.appendChild(line)
    output.scrollTop = output.scrollHeight
  }

  function escapeHtml(text: string): string {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
  }

  function clearOutput() {
    output.innerHTML = ""
  }

  async function loadVersion(release: WasmRelease) {
    input.disabled = true
    input.placeholder = "Loading..."

    if (currentModule) {
      currentModule.destroy()
      currentModule = null
    }

    clearOutput()
    appendOutput(`Loading Lus ${release.version}...`, "system")

    try {
      currentModule = await loadLusWasm(release)
      clearOutput()
      appendOutput(`Lus ${release.version} â€” Type expressions to evaluate`, "system")
      appendOutput('Try: print("Hello, Lus!") or 1 + 1', "system")
      input.disabled = false
      input.placeholder = "Enter Lus code..."
      input.focus()
      versionTag.textContent = release.isStable ? "stable" : "unstable"
      versionTag.className = release.isStable ? "tag stable" : "tag unstable"
    } catch (e) {
      appendOutput(`Failed to load: ${e}`, "error")
      input.placeholder = "Failed to load"
    }
  }

  function executeCode(code: string) {
    if (!currentModule || !code.trim()) return

    appendOutput(code, "input")
    history.unshift(code)
    historyIndex = -1

    try {
      const result = currentModule.execute(code)
      if (result && result.trim()) {
        appendOutput(result.trimEnd(), "output")
      }
    } catch (e) {
      appendOutput(String(e), "error")
    }

    input.value = ""
  }

  // Initialize
  async function init() {
    try {
      releases = await getWasmReleases()

      versionSelect.innerHTML = ""

      if (releases.stable) {
        const opt = document.createElement("option")
        opt.value = "stable"
        opt.textContent = `${releases.stable.version} (stable)`
        versionSelect.appendChild(opt)
      }

      if (releases.unstable) {
        const opt = document.createElement("option")
        opt.value = "unstable"
        opt.textContent = `${releases.unstable.version} (unstable)`
        versionSelect.appendChild(opt)
      }

      if (!releases.stable && !releases.unstable) {
        appendOutput("No WASM builds available yet.", "error")
        return
      }

      versionSelect.disabled = false

      // Load default version (stable if available, else unstable)
      const defaultRelease = releases.stable || releases.unstable
      if (defaultRelease) {
        await loadVersion(defaultRelease)
      }
    } catch (e) {
      appendOutput(`Failed to fetch releases: ${e}`, "error")
    }
  }

  // Event handlers
  versionSelect.addEventListener("change", async () => {
    const selected = versionSelect.value
    const release = selected === "stable" ? releases.stable : releases.unstable
    if (release) {
      await loadVersion(release)
    }
  })

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      executeCode(input.value)
    } else if (e.key === "ArrowUp") {
      if (history.length > 0 && historyIndex < history.length - 1) {
        historyIndex++
        input.value = history[historyIndex]
        e.preventDefault()
      }
    } else if (e.key === "ArrowDown") {
      if (historyIndex > 0) {
        historyIndex--
        input.value = history[historyIndex]
      } else if (historyIndex === 0) {
        historyIndex = -1
        input.value = ""
      }
      e.preventDefault()
    }
  })

  init()
</script>

<style>
  @reference "../styles/global.css";

  .playground {
    @apply border border-lime-600 lus-shadow shadow-lime-600/40 bg-lime-950 text-lime-100 font-mono text-sm;
  }

  .playground-header {
    @apply flex items-center justify-between px-4 py-2 bg-lime-900 border-b border-lime-700;

    h2 {
      @apply text-lime-300 font-bold lowercase text-base;
    }
  }

  .version-controls {
    @apply flex items-center gap-2;

    select {
      @apply bg-lime-800 text-lime-200 border border-lime-600 px-2 py-1 text-xs cursor-pointer;

      &:disabled {
        @apply opacity-50 cursor-not-allowed;
      }
    }

    .tag {
      @apply px-2 py-0.5 text-xs font-bold uppercase;

      &.stable {
        @apply bg-lime-600 text-lime-950;
      }

      &.unstable {
        @apply bg-red-600 text-red-100;
      }
    }
  }

  .playground-body {
    @apply p-4;
  }

  .output {
    @apply max-h-64 overflow-y-auto mb-2 space-y-1;
  }

  .output-line {
    @apply whitespace-pre-wrap break-all;

    &.system {
      @apply text-lime-500 italic;
    }

    &.input {
      @apply text-lime-300;
    }

    &.output {
      @apply text-lime-100;
    }

    &.error {
      @apply text-red-400;
    }

    .prompt {
      @apply text-lime-500 select-none mr-2;
    }
  }

  .input-line {
    @apply flex items-center gap-2 border-t border-lime-800 pt-2;

    .prompt {
      @apply text-lime-500 select-none;
    }

    input {
      @apply flex-1 bg-transparent text-lime-100 outline-none placeholder-lime-700;

      &:disabled {
        @apply opacity-50;
      }
    }
  }
</style>

